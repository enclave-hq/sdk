# ğŸ” KMSåŒå±‚åŠ å¯†æ¶æ„è§£æ

## æ¶æ„æ¦‚è¿°
```
ç§é’¥ --[K1åŠ å¯†]--> EncPK --[K2åŠ å¯†]--> EncPK2 (å­˜å‚¨åœ¨æ•°æ®åº“)
     (BackendæŒæœ‰)        (KMSå†…å­˜)      (æ•°æ®åº“æŒä¹…åŒ–)
```

## ä¸‰å±‚é˜²æŠ¤æœºåˆ¶

### 1. **åŸå§‹ç§é’¥ (PrvK)**
- ç”¨æˆ·çš„å®é™…ç§é’¥
- åªåœ¨ç­¾åæ—¶çŸ­æš‚å­˜åœ¨äºå†…å­˜
- ç­¾åå®Œæˆåç«‹å³æ¸…é›¶

### 2. **K1ä¼ è¾“å¯†é’¥ (encrypted_key)**
- BackendæŒæœ‰çš„ä¼ è¾“åŠ å¯†å¯†é’¥
- ç”¨äºç¬¬ä¸€å±‚åŠ å¯†ï¼š`PrvK --[K1]--> EncPK`
- è¿™å°±æ˜¯APIä¸­çš„ `encrypted_key` å‚æ•°ï¼

### 3. **K2å­˜å‚¨å¯†é’¥**
- KMSå†…å­˜ä¸­çš„å­˜å‚¨åŠ å¯†å¯†é’¥
- ç”¨äºç¬¬äºŒå±‚åŠ å¯†ï¼š`EncPK --[K2]--> EncPK2`
- ç”±Local/AWS KMSè¿›ä¸€æ­¥ä¿æŠ¤

## APIè°ƒç”¨æµç¨‹

### å­˜å‚¨ç§é’¥æ—¶ï¼š
1. Backendè°ƒç”¨ï¼š`POST /api/v1/dual-layer/encrypt`
2. KMSç”ŸæˆK1ï¼Œè¿”å›ç»™Backend
3. KMSç”¨K2åŠ å¯†å­˜å‚¨åˆ°æ•°æ®åº“
4. Backendä¿å­˜K1ä½œä¸º `encrypted_key`

### ç­¾åæ—¶ï¼š
1. Backendå‘é€ï¼š`encrypted_key` (K1) + å¾…ç­¾åæ•°æ®
2. KMSç”¨K1è§£å¯†å¾—åˆ°EncPK
3. KMSç”¨K2è§£å¯†å¾—åˆ°åŸå§‹ç§é’¥
4. æ‰§è¡Œç­¾åï¼Œç«‹å³æ¸…é›¶ç§é’¥

## å…³é”®ç†è§£

**`encrypted_key` = K1ä¼ è¾“å¯†é’¥**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š
- æ‰€æœ‰ç­¾åAPIéƒ½éœ€è¦ `encrypted_key` å‚æ•°
- `encrypted_key` æ˜¯Backendå’ŒKMSä¹‹é—´çš„"é’¥åŒ™"
- é€šè¿‡ `key_alias + chain_id` å¯ä»¥æŸ¥åˆ°å¯¹åº”çš„ `encrypted_key`
